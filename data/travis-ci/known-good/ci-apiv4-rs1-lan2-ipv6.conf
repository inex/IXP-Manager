#
# Bird Route Server configuration generated by IXP Manager
#
# Do not edit this file, it will be overwritten. Please see:
#
# https://github.com/inex/IXP-Manager/wiki/Route-Server
#
# Generated: 2016-11-07 19:39:55
#

# For VLAN: {$t->vlan->getName()} (Tag: {$t->vlan->getNumber()}, Database ID: {$t->vlan->getId()})

log "/var/log/bird/rs1-lan2-ipv6.log" all;
log syslog all;

define routeserverasn     = 65501;
define routeserveraddress = 2001:db8::19;

router id 192.0.2.19;

listen bgp address routeserveraddress;

# ignore interface up/down events
protocol device { }

# This function excludes weird networks
#  rfc1918, class D, class E, too long and too short prefixes
function avoid_martians()
prefix set martians;
{
    
        martians = [
                ::/0,                   # Default (can be advertised as a route in BGP to peers if desired)
                ::/96,                  # IPv4-compatible IPv6 address - deprecated by RFC4291
                ::/128,                 # Unspecified address
                ::1/128,                # Local host loopback address
                ::ffff:0.0.0.0/96+,     # IPv4-mapped addresses
                ::224.0.0.0/100+,       # Compatible address (IPv4 format)
                ::127.0.0.0/104+,       # Compatible address (IPv4 format)
                ::0.0.0.0/104+,         # Compatible address (IPv4 format)
                ::255.0.0.0/104+,       # Compatible address (IPv4 format)
                0000::/8+,              # Pool used for unspecified, loopback and embedded IPv4 addresses
                0200::/7+,              # OSI NSAP-mapped prefix set (RFC4548) - deprecated by RFC4048
                3ffe::/16+,             # Former 6bone, now decommissioned
                2001:db8::/32+,         # Reserved by IANA for special purposes and documentation
                2002:e000::/20+,        # Invalid 6to4 packets (IPv4 multicast)
                2002:7f00::/24+,        # Invalid 6to4 packets (IPv4 loopback)
                2002:0000::/24+,        # Invalid 6to4 packets (IPv4 default)
                2002:ff00::/24+,        # Invalid 6to4 packets
                2002:0a00::/24+,        # Invalid 6to4 packets (IPv4 private 10.0.0.0/8 network)
                2002:ac10::/28+,        # Invalid 6to4 packets (IPv4 private 172.16.0.0/12 network)
                2002:c0a8::/32+,        # Invalid 6to4 packets (IPv4 private 192.168.0.0/16 network)
                fc00::/7+,              # Unicast Unique Local Addresses (ULA) - RFC 4193
                fe80::/10+,             # Link-local Unicast
                fec0::/10+,             # Site-local Unicast - deprecated by RFC 3879 (replaced by ULA)
                ff00::/8+,              # Multicast
                ::/0{49,128}            # Filter small prefixes
        ];

    
        # Avoid RFC1918 and similar networks
        if net ~ martians then
                return false;

        return true;
}


##
## Standard IXP community filter
##

function ixp_community_filter(int peerasn)
{
        if !(source = RTS_BGP) then
                return false;

        # it's unwise to conduct a 32-bit check on a 16-bit value
        if peerasn > 65535 then
                return true;

        # Implement widely used community filtering schema.
        if (0, peerasn) ~ bgp_community then
                return false;
        if (routeserverasn, peerasn) ~ bgp_community then
                return true;
        if (0, routeserverasn) ~ bgp_community then
                return false;

        return true;
}


##
## Route Server client configuration
##

template bgp tb_rsclient {
        local as routeserverasn;
        source address routeserveraddress;
        import filter {
                ## Prevent BGP NEXT_HOP Hijacking
                if !( from = bgp_next_hop ) then
                    reject "BGP neighbor address [", from, "] != next hop address [", bgp_next_hop, "]", ", net:[", net, "], path:[", bgp_path, "]";

                accept;
        };

        export all;
        rs client;
        missing lladdr ignore;

}




### AS1213 - HEAnet - VLAN Interface #2
table t_0002_as1213;


filter f_import_0002_as1213
prefix set allnet;
int set allas;
{
    if !(avoid_martians()) then
            reject;

    # Route servers peering with route servers will cause the universe
    # to collapse.  Recommend evasive manoeuvers.
    if (bgp_path.first != 1213 ) then
            reject;

    allas = [ 112, 1213, 1921, 2128, 2850, 42310 ];


    if !(bgp_path.last ~ allas) then
           reject;


    allnet = [ 2001:1900:2205::/48, 2001:1900:2206::/48, 2001:678:20::/48, 2001:678:24::/48, 2001:67c:10b8::/48, 2001:67c:10e0::/48, 2001:67c:1bc::/48, 2001:770::/32, 2001:7f8:18::/48, 2620:4f:8000::/48, 2a01:4b0::/32 ];

    if ! (net ~ allnet) then
            reject;



    accept;
}

protocol pipe pp_0002_as1213 {
        description "Pipe for AS1213 - HEAnet - VLAN Interface 2";
        table master;
        mode transparent;
        peer table t_0002_as1213;
        import filter f_import_0002_as1213;
        export where ixp_community_filter(1213);
}

protocol bgp pb_0002_as1213 from tb_rsclient {
        description "AS1213 - HEAnet";
        neighbor 2001:db8:2::11 as 1213;
        import limit 1000 action restart;
        table t_0002_as1213;
        password "u5zSNJLAVT87RGXQ";
}


