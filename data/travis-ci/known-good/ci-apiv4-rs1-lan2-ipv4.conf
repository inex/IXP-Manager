#
# Bird Route Server configuration generated by IXP Manager
#
# Do not edit this file, it will be overwritten. Please see:
#
# https://github.com/inex/IXP-Manager/wiki/Route-Server
#
# Generated: 2019-03-09 15:29:56
#

# For VLAN: Peering LAN 2 (Tag: 2, Database ID: 2)

# standardise time formats:
timeformat base         iso long;
timeformat log          iso long;
timeformat protocol     iso long;
timeformat route        iso long;


log "/var/log/bird/rs1-lan2-ipv4.log" all;
log syslog all;

define routeserverasn     = 65501;
define routeserveraddress = 192.0.2.19;

router id 192.0.2.19;

listen bgp address routeserveraddress;

# ignore interface up/down events
protocol device { }

# This function excludes weird networks
#  rfc1918, class D, class E, too long and too short prefixes
function avoid_martians()
prefix set martians;
{
    
        martians = [
                10.0.0.0/8+,
                169.254.0.0/16+,
                172.16.0.0/12+,
                192.0.0.0/24+,
                192.0.2.0/24+,
                192.168.0.0/16+,
                198.18.0.0/15+,
                198.51.100.0/24+,
                203.0.113.0/24+,
                224.0.0.0/4+,
                240.0.0.0/4+,
                0.0.0.0/32-,
                0.0.0.0/0{25,32},
                0.0.0.0/0{0,7}
        ];

    
        # Avoid RFC1918 and similar networks
        if net ~ martians then
                return false;

        return true;
}


##
## Standard IXP community filter
##

function ixp_community_filter(int peerasn)
{
        if !(source = RTS_BGP) then
                return false;

        # support for BGP Large Communities
        if (routeserverasn, 0, peerasn) ~ bgp_large_community then
                return false;
        if (routeserverasn, 1, peerasn) ~ bgp_large_community then
                return true;
        if (routeserverasn, 0, 0) ~ bgp_large_community then
                return false;
        if (routeserverasn, 1, 0) ~ bgp_large_community then
                return true;

        # Implement widely used community filtering schema.
        if ((peerasn < 65536) && ((0, peerasn) ~ bgp_community)) || (ro, 0, peerasn) ~ bgp_ext_community then
                return false;
        if ((peerasn < 65536) && ((routeserverasn, peerasn) ~ bgp_community)) || (ro, routeserverasn, peerasn) ~ bgp_ext_community then
                return true;
        if (0, routeserverasn) ~ bgp_community || (ro, 0, routeserverasn) ~ bgp_ext_community then
                return false;

        return true;
}


##
## Route Server client configuration
##

template bgp tb_rsclient {
        local as routeserverasn;
        source address routeserveraddress;
        import filter {
                ## Prevent BGP NEXT_HOP Hijacking
                if !( from = bgp_next_hop ) then
                    reject "BGP neighbor address [", from, "] != next hop address [", bgp_next_hop, "]", ", net:[", net, "], path:[", bgp_path, "]";

                accept;
        };

        export all;
        rs client;

}




### AS112 - AS112 - VLAN Interface #5
table t_0005_as112;


filter f_import_0005_as112
prefix set allnet;
int set allas;
{
    if !(avoid_martians()) then
            reject;

    # Route servers peering with route servers will cause the universe
    # to collapse.  Recommend evasive manoeuvers.
    if (bgp_path.first != 112 ) then
            reject;

    allas = [ 112 ];


    if !(bgp_path.last ~ allas) then
           reject;


    allnet = [ 192.175.48.0/24 ];

    if ! (net ~ allnet) then
            reject;



    accept;
}

protocol pipe pp_0005_as112 {
        description "Pipe for AS112 - AS112 - VLAN Interface 5";
        table master;
        mode transparent;
        peer table t_0005_as112;
        import filter f_import_0005_as112;
        export where ixp_community_filter(112);
}

protocol bgp pb_0005_as112 from tb_rsclient {
        description "AS112 - AS112";
        neighbor 10.2.0.6 as 112;
        import limit 20 action restart;
        table t_0005_as112;
        password "Pz8VYMNwEdCjKz68";
}


### AS1213 - HEAnet - VLAN Interface #2
table t_0002_as1213;


filter f_import_0002_as1213
prefix set allnet;
int set allas;
{
    if !(avoid_martians()) then
            reject;

    # Route servers peering with route servers will cause the universe
    # to collapse.  Recommend evasive manoeuvers.
    if (bgp_path.first != 1213 ) then
            reject;

    allas = [ 112, 1213, 1921, 2128, 2850, 42310 ];


    if !(bgp_path.last ~ allas) then
           reject;


    allnet = [ 4.53.84.128/26, 4.53.146.192/26, 77.72.72.0/21, 87.32.0.0/12, 91.123.224.0/20, 134.226.0.0/16, 136.201.0.0/16, 136.206.0.0/16, 137.43.0.0/16, 140.203.0.0/16, 143.239.0.0/16, 147.252.0.0/16, 149.153.0.0/16, 149.157.0.0/16, 157.190.0.0/16, 160.6.0.0/16, 176.97.158.0/24, 192.174.68.0/24, 192.175.48.0/24, 193.1.0.0/16, 193.242.111.0/24, 194.0.24.0/24, 194.0.25.0/24, 194.0.26.0/24, 194.88.240.0/23, 212.3.242.128/26 ];

    if ! (net ~ allnet) then
            reject;



    accept;
}

protocol pipe pp_0002_as1213 {
        description "Pipe for AS1213 - HEAnet - VLAN Interface 2";
        table master;
        mode transparent;
        peer table t_0002_as1213;
        import filter f_import_0002_as1213;
        export where ixp_community_filter(1213);
}

protocol bgp pb_0002_as1213 from tb_rsclient {
        description "AS1213 - HEAnet";
        neighbor 10.2.0.11 as 1213;
        import limit 1000 action restart;
        table t_0002_as1213;
        password "u5zSNJLAVT87RGXQ";
}


